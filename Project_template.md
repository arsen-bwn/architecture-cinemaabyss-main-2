# Задание 1

1. Спроектировал to be архитектуру КиноБездны, разделив всю систему на отдельные домены и организовал интеграционное взаимодействие и единую точку вызова сервисов.
Результат представляю в виде контейнерной диаграммы в нотации С4.

[Диаграмма контейнеров](./C4/conteiner_diagram.wsd)

# Задание 2

### 1. Proxy
Команда КиноБездны уже выделила сервис метаданных о фильмах movies и вам необходимо реализовать бесшовный переход с применением паттерна Strangler Fig в части реализации прокси-сервиса (API Gateway), с помощью которого можно будет постепенно переключать траффик, используя фиче-флаг.


Прокси сервис реализовал на TS [тут](./src/microservices/proxy/)

- После реализации запустил postman тесты - они все должны быть зеленые (кроме events).
[Скрин тестов с ошибками events](./screens/postman-test1:2.png)
Так как не увидел в описании что тест должен быть с ошибками, я их исправил
[Скрин тестов без ошибок](./screens/postman-test1.png)

Протестировал постепенный переход изменяя значения от 0 до 100 с шагом 20


### 2. Kafka
Проверил гипотезу применение Kafka в данной архитектуре.

Для этого реализовал MVP сервис events, который будет при вызове API создавать и сам же читать сообщения в топике Kafka.

    - Разработал сервис на  языке программирования TS с consumer'ами и producer'ами.
    - Реализовал простой API, при вызове которого будут создаваться события User/Payment/Movie и обрабатываться внутри сервиса с записью в лог
    - Доработал в docker-compose новый сервис, kafka там уже была

Необходимые тесты для проверки этого API вызываются при запуске npm run test:local из папки tests/postman 
Приложил скриншоы тестов и скриншоты состояния топиков Kafka из UI http://localhost:8090

[Скрин kafka topic movie](./screens/kafka-topic-movie-pac.png)
[Скрин kafka topic movie](./screens/kafka-topic-movie.png)
[Скрин kafka topic user](./screens/kafka-topic-user.png)

# Задание 3

Команда начала переезд в Kubernetes для лучшего масштабирования и повышения надежности. 
Вам, как архитектору осталось самое сложное:
 - реализовать CI/CD для сборки прокси сервиса
 - реализовать необходимые конфигурационные файлы для переключения трафика.


### CI/CD

 В папке .github/worflows доработал деплой новых сервисов proxy и events в docker-build-push.yml , чтобы api-tests при сборке отрабатывали корректно при отправке коммита в ваш репозиторий.


Как только сборка отработает и в github registry появятся образы

На GitHub в разделе Actions сборка и тесты "зеленые"


### Proxy в Kubernetes

#### Шаг 1 
Для деплоя в kubernetes  залогинился в docker registry Github'а.
1. Создал Personal Access Token (PAT) https://github.com/settings/tokens . 

2. В src/kubernetes/*.yaml (event-service, monolith, movies-service и proxy-service)  отредактировал путь образов

3. Добавил в секрет src/kubernetes/dockerconfigsecret.yaml в поле
```bash
 .dockerconfigjson: значение в base64 файла ~/.docker/config.json
```



#### Шаг 2

  Доработал src/kubernetes/event-service.yaml и src/kubernetes/proxy-service.yaml

  -  Создал Deployment и Service 
  - Доработайте ingress.yaml, чтобы можно было с помощью тестов проверить создание событий
  - Выполнил дальшейшие шаги для поднятия кластера. Тут я ошибся с конфигурацией так как нужно было указать дополнительно linux/arm64 для Apple silicon. Этот просчет съел много времени на диагностику и повторную сборку. По этой причине рекомендую упомянуть этот тонкий момент в постановке задания.

   [Скриншот лога обработки событий event-service](./screens/task3:11-1.png)



#### Шаг 3
Добавил сюда скриншота вывода при вызове https://cinemaabyss.example.com/api/movies и  скриншот вывода event-service после вызова тестов.
[Скриншот вывода тестов event-service](./screens/task3:11.png)

[Скрин вывода при вызове https://cinemaabyss.example.com](./screens/task3:12.png)



# Задание 4
Для простоты дальнейшего обновления и развертывания реализовал helm-чарты для прокси-сервиса и проверил работу 


Открыл https://cinemaabyss.example.com/api/movies
и приложил скриншот развертывания helm и вывода https://cinemaabyss.example.com/api/movies
[Скриншот развертывания helm](./screens/task4:1.png)
[Скриншот развертывания helm](./screens/task4-2.png)